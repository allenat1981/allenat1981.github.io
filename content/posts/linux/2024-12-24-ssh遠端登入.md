---
title: "ssh 遠端登入"
date: 2024-12-24 10:00:00 +0800
categories: 
  - Linux
tags:
  - Linux
---


使用 SSH 進行遠端登入的筆記。

## 參考資料

- [產生SSH Key並且透過KEY進行免密碼登入](https://xenby.com/b/220-%E6%95%99%E5%AD%B8-%E7%94%A2%E7%94%9Fssh-key%E4%B8%A6%E4%B8%94%E9%80%8F%E9%81%8Ekey%E9%80%B2%E8%A1%8C%E5%85%8D%E5%AF%86%E7%A2%BC%E7%99%BB%E5%85%A5)
- [SSH 連線使用 SSH Key 登入(免密碼)](https://cjk.aiao.today/ssh-key_login_2021/)
- [SSH 公開金鑰認證：不用打密碼登入 Linux 設定教學，安全又方便](https://blog.gtwang.org/linux/linux-ssh-public-key-authentication/)

## 練習環境

- Server
  - IP: 192.168.0.241
  - User: beyond
- Client
  - IP: 192.168.0.110
  - User: allen

由 Client 端使用者帳號 allen 登入到 Server 端使用者帳號 beyond

### 安裝 ssh 服務

Server 端安裝 openssh-server

```bash
sudo apt install openssh-server
```

Client 端安裝 ssh

```bash
# 通常已內建 ssh，若沒有才需要安裝
sudo apt install ssh
```

Server 端的防火牆開啟 TCP 22 白名單。

若需要設定防火牆請參考[Firewalld防火牆](Debian11/Firewalld防火牆.md)

### 使用密碼登入

```bash
# 在 Client 端直接使用 ssh 指令
ssh beyond@192.168.0.241
# 要求輸入 beyond 的密碼，密碼正確後即可登入
```

## 使用金鑰登入(不須密碼)

適用：確定 Client 為資安無虞的主機，且通常只固定從此主機登入 Server。若需要常常換電腦登入則不適用。

### 建立金鑰

請在 Client 端進行以下操作。

建立金鑰：

```bash
# 使用 ssh-keygen 建立金鑰
# -C 可以加上註解，例如 email 或主機名稱，方便管理員辨識金鑰來源。建議加上來源，方便之後進行管理。
# -f 可以設定輸出的檔案路徑與名稱，可以用來區分金鑰用途。若沒有指定，預設會在 ~./ssh 目錄產生公鑰檔 id_rsa.pub 和私鑰檔 id_rsa。

ssh-keygen -C "comments" -f ~/.ssh/id_myhost

# 會詢問是否使用密碼，若有輸入密碼則之後用 ssh 登入時仍需要此組密碼。
# 若想要不輸入密碼即可用 ssh 登入，就不要設定密碼。
# 此範例會產生私鑰檔 id_myhost 和公鑰檔 id_myhost.pub
```

### 將公鑰加入到 Server 端

使用 scp 複製公鑰到 Server

```bash
scp ~/.ssh/id_myhost.pub beyond@192.168.0.241:~
```

接這可先用密碼登入到 Server 端，或直接在 Server 端操作。

```bash
# 建立 ~/.ssh 目錄(若目錄已存在則略過)
mkdir ~/.ssh

# 建立 ~/.ssh/authorized_keys 檔案(若檔案已存在則略過)
touch ~/.ssh/authorized_keys
```

{{< alert type="notice" >}}
若要重新設定，例如想要更新公鑰，或者太雜亂想要全部重設，也可以移除 authorized_keys 後重新建立。或者是直接更改檔名 authorized_keys.bak 留存後，建立新的 authorized_keys。
{{< /alert >}}

將公鑰附加到 authorized_keys：

```bash
cat ~/id_myhost.pub >> ~/.ssh/authorized_keys
```

更新目錄及檔案權限：

```bash
# 為確保資安，請將 .ssh 目錄設為 700，authorized_keys 設為 600。
# 若使用 ls -al 檢查權限無誤，也可略過此步驟。
chown -R beyond:beyond ~/.ssh
chmod 700 ~/.ssh
chomd 600 ~/.ssh/authorized_keys
```

將公鑰匯入到 authorized_keys 後，可移除上傳的公鑰檔

```bash
rm ~/id_myhost.pub
```

### 使用金鑰連線到 Server

從 Client 端嘗試連線到 Server

```bash
ssh -i ~/.ssh/id_myhost beyond@192.168.0.241

# 若設定成功即可用金鑰登入密碼
# 若金鑰有設定密碼，則可能需要輸入金鑰密碼
```

### 設定 ssh config 檔

可在 Client 端設定 ~/.ssh/config 檔，簡化 ssh 連線到主機

在 Client 端建立或編輯 ~/.ssh/config

```conf
Host beyond
  HostName 192.168.0.241 # IP 或主機名稱(DNS FQDN)
  User beyond # 使用者名稱
  IdentityFile ~/.ssh/id_myhost # 私鑰路徑

# 可以設定多筆Host，以換行方開 
Host otherServer
#...
```

即可在 Client 使用 ssh 進行快速連線

```bash
# 連線到設定好的 Host beyond
ssh beyond
```

### 狀況：刪除不使用的公鑰

若要禁止 Client 端使用金鑰連線至 Server，則必須將公鑰從 Server 的 authorized_keys 移除。

最直覺的方式是使用手動編輯的方式，用 nano 或 vim 修改 ~/.ssh/authorized_keys。

刪除前建議先將 ~/.ssh/authorized_keys 進行備份。

通常公鑰會用 ssh-ed25519 或 ssh-rsa 開頭，並且到尾端的註解為止(建議建立公要時加上 -C 註解)，將整段刪除後儲存。
