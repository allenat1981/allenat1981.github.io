---
title: "tar 指令做增量備份"
date: 2025-01-10 13:50:00 +0800
categories: 
  - Linux
tags:
  - Linux
---

## 參考資料

- [鳥哥的LINUX私房菜 tar](http://linux.vbird.org/linux_basic/0240tarcompress.php#pack)
- [記下來 Linux tar 完整備份、增量備份及差異備份比較](https://noter.tw/32/linux-tar-%E5%AE%8C%E6%95%B4%E5%82%99%E4%BB%BD%E3%80%81%E5%A2%9E%E9%87%8F%E5%82%99%E4%BB%BD%E5%8F%8A%E5%B7%AE%E7%95%B0%E5%82%99%E4%BB%BD%E6%AF%94%E8%BC%83/)

## 適用情境

若要做檔案基本的備份可以用 tar 來打包整個資料夾，加上 snapshot 則可進行增量備份。若要做整個系統重裝或資料移到其他機器，可以使用此方法進行檔案輸出。

## 不適用的情境

- 增量備份是透過每次打包時比對 snapshot ，只把有異動的檔案進行打包。
- 增量備份的作法是將有異動的檔案抓出來再打包，相當於還是備份整個檔案，而非只備份檔案有被異動的內容，因此若是大型的檔案則不適合常常進行備份，e.g. MySQL 的資料檔，若第一次備份有 500 MB，後來增加到 550 MB，就相當於會有第一次的 500MB + 第二次的 550MB，也就是每備份一次，就會增加一個 500MB 以上的 MySQL 資料檔。

## 實作

### 備份目錄

```bash
# 將 /home/allen 資料夾備份到 /backup/backup-1.tar.gz
# 第一次備份
sudo tar -cpvz -f /backup/backup-1.tar.gz /home/allen -g snapshot
# 會在目前的位置產生 snapshot 檔案做為增量快照比對。
# 建議可以把 snapshot 建立在要備份的目錄下。
```

常用 tar 參數：

`c` 建立打包檔(create)。
`x` 解開打包檔。
`t` 檢視打包檔案的內容含有哪些檔名。
`z` 使用 gzip 壓縮/解壓縮。檔名請取為 \*.tar.gz。
`j` 使用 bzip2 壓縮/解壓縮。檔名請取為 \*.tar.bz2。
`J` 使用 xz 壓縮/解壓縮。檔名請取為 \*.tar.xz。
`p` 保留檔案的屬性。若要搬到其他系統(例如：移機)則需考慮是否加上此參數(若新機器的使用者名單與原機器不同)。
`v` 壓縮過程中顯示檔案(輸出到stdout)。
`f` 產生的檔案名稱。f 後面要直接接檔名，故建議另外接 `-f <filename>`。
`g` 產生快照檔。用來做增量備份的比對，故另外接 `-g <filename>`。請注意！若要做增量備份，則每次 tar 指令都要使用 -g 指定到正確的 snapshot 檔案。
`C` 指定解壓縮的目錄。

每次使用 tar 指令時，以下分組的 options 在同一次指令中不可同時出現：

- [-c, -x, -t] 不可同時建立打包又解開打包，故此三者僅可擇一。
- [-z, -j, -J] 不可同時用不同的壓縮方式，故此三者僅可擇一。

若之後要進行增量備份：

```bash
# 建議用 script 定期備份來指定輸出檔名
# snapshot 必須要指定同一個
# 第二次備份
sudo tar -cpvz -f /backup/backup-2.tar.gz /home/allen -g snapshot
# 第 n 次備份
...
```

### 解壓縮

```bash
# 若要復原到最後備份的狀態，需依照備份順序進行解壓縮
# 若要解壓縮到其他目錄可加上 -C <目錄>
# 將備份的資料解壓縮到 /tmp
# 復原第一次備份
sudo tar -xvz -f backup-1.tar.gz -C /tmp
# 復原第二次備份
sudo sudo tar -xvz -f backup-2.tar.gz -C /tmp
# 復原到第 n 次備份
...
```

## 補充：三種備份方式的說明

### 完整備份

作用：將整個備份的目標複製一份。

優點：可直接復原資料完整的狀態。
缺點：備份時間較長，空間使用量大。

### 差異備份

作用：先做一次完整備份 A(0)，之後每第 N 次備份都和 A(0) 進行比對，只要有差異的檔案就都會被備份。

例如：
2022/01/27 第一次完整備份資料夾 A 為 A(0)，裡面有檔案 F1 F2 F3。
2022/01/28 在資料夾 A 修改 F1 F2 ，新增 F4。進行差異備份A(1)，備份內容為 F1 F2 F4
2022/01/29 在資料夾新增 F5，進行差異備份A(2)，備份內容為 F1 F2 F4 F5。

可以發現即使在 A(1) 到 A(2) 二次備份之間 F1 F2 F4 沒有被異動過，仍然會被備份到 A(2)。

復原資料時可直接搭配 A(0) + A(N) 回復到第 N 次備份。

優點：可減少完整備份的空間使用量，復原到第 N 次的備份只需要 A(0) + A(N) 2 個步驟，速度較快。
缺點：隨時間推移，檔案異動越多，空間使用量也會慢慢變大，備份時間也會慢慢變多。

### 增量備份

作用：先做一次完整備份 A，之後每第 N 次備份都對 A(N-1) 進行比對，只備份有差異的檔案。

例如：
2022/01/27 第一次完整備份資料夾 A 為 A(0)，裡面有檔案 F1 F2 F3。
2022/01/28 在資料夾 A 修改 F1 F2 ，新增 F4。進行增量備份A(1)，備份內容為 F1 F2 F4。
2022/01/29 在資料夾 A 新增 F5 ，進行增量備份A(2)，備份內容為 F5。

可以發現與差異備份的差別在於 A(1) 與 A(2) 之間只有 F5 異動，因此只有 F5 會被備份到 A(2)。

若要回復到 A(N) 的資料，必須從 A(0), A(1), A(2), ... A(N) 依序進行復原。

優點：每次只備份時僅與前一次備份比對有異動的檔案，備份時間較快且使用空間較少。
缺點：要復原到第 N 次備份狀態必須從 A(0) 到 A(N) 共 N + 1 個步驟，復原時間較長。

注意！差異備份或增量備份的實作，可能是比對檔案修改時間(比較有可能)或檔案大小(比較不可能)，而並非真的比對檔案內容。並且備份的時候是會把整個檔案備份下來，而不是只去備份 2 個檔案內容有差異的部分(應該沒那麼聰明)。

例如：

有一個檔案 Hello.txt

```text
Hello World
```

進行第一次備份 A(0)。

接著更改內容

```text
Hello World
What a wonderful wrold
```

進行第二次備份 A(1)。

此時代表有 2 個完整 的 Hello.txt 檔案。
