---
title: "建置 php:7.2.34-fpm 網站開發環境"
date: 2025-11-22 18:30:00 +0800
categories: 
  - docker
tags:
  - docker
  - php-fpm
---

php-apache 環境從 container 執行 php 寫入 host 的 volumes 會有權限上的問題。此筆記使用 php-fpm 和 apache(httpd) 來設定環境，讓 container 的 user 與 host 的 user 一致，可以存取 volumes 對應的目錄權限。

{{< alert type="warning" >}}
此筆記的資料來自 ChatGPT 和 Gemini 提供的答案整理測試，僅適用於開發環境。
{{< /alert >}}

## 專案檔案與目錄說明

- 專案目錄為 `mysite`
- 使用 php:7.2.34-fpm 和 httpd:2.4 運行網站
- 加上測試用自簽憑證
- 使用 `www.mysite.localhost` 作為主機名稱
  - `http://www.mysite.localhost:4080`
  - `https://www.mysite.localhost:4443`
- 資料庫為 host 所安裝的 mariadb 11。

## 專案目錄結構配置

在專案目錄 mysite 下加入以下檔案與目錄結構

```conf
mysite/
    apache/
        ssl/
            ssl.crt
            ssl.key
        Dockerfile # 自訂 httpd image
        httpd.conf # httpd 設定檔
        vhost.cnf # virtual host 設定檔
    php/
        Dockerfile # 自訂 php-fpm image

  docker-compose.yml # docker compose 設定檔
```

### 設定 hosts 路由表

因為使用自訂主機名稱 `www.mysite.localhost`，需要修改 `/etc/hosts`。

```bash
sudo vi /etc/hosts
```

加入以下

```ini
127.0.0.1 www.mysite.localhost
```

### 建立測試憑證

切換工作目錄至 mysite/apache/ssl

```bash
# 工作目錄: mysite/apache/ssl

# 使用 openssl 生成私鑰 (ssl.key) 和憑證 (ssl.crt)
# 建立有效 10 年憑證
# CN=www.mysite.localhost 是重點，必須與您設定的網址一致
openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
    -keyout ssl.key \
    -out ssl.crt \
    -subj "/C=TW/ST=Taipei/L=Sanchong/O=MySite Dev/CN=www.mysite.localhost"

# 執行後產生 ssl.crt 與 ssl.key
```

### 建立 apache/Dockerfile

```Dockerfile{linenos=true}
FROM httpd:2.4

# 可傳入參數 USER_ID 和 GROUP_ID
# 預設使用 1000
ARG USER_ID=1000
ARG GROUP_ID=1000

# 建立主機相同 UID/GID 的使用者
RUN groupadd -g ${GROUP_ID} hostuser \
    && useradd -u ${USER_ID} -g hostuser -m hostuser

# 修改 Apache 設定使用這個 User
RUN sed -i 's/^User .*/User hostuser/' /usr/local/apache2/conf/httpd.conf \
    && sed -i 's/^Group .*/Group hostuser/' /usr/local/apache2/conf/httpd.conf

WORKDIR /var/www/html
```

### 建立 apache/httpd.conf

```conf{linenos=true}
LoadModule unixd_module modules/mod_unixd.so
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule dir_module modules/mod_dir.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
LoadModule rewrite_module modules/mod_rewrite.so

ServerName www.mysite.localhost
Listen 80
Listen 443

EnableSendfile Off

Include conf/extra/httpd-vhosts.conf
```

### 建立 apache/vhost.conf

```conf{linenos=true}
<Directory /var/www/html>
    Require all granted
</Directory>

<Directory /var/www/html/public_html>
    AllowOverride All
    Require all granted
    DirectoryIndex index.php index.html
</Directory>

<VirtualHost *:80>
    ServerName www.mysite.localhost
    DocumentRoot "/var/www/html/public_html"

    ProxyPassMatch "^/(.*\.php)$" "fcgi://phpfpm:9000/var/www/html/public_html/$1"

    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>

<VirtualHost *:443>
    ServerName www.mysite.localhost
    DocumentRoot "/var/www/html/public_html"

    SSLEngine on
    SSLCertificateFile "/usr/local/apache2/conf/ssl/ssl.crt"
    SSLCertificateKeyFile "/usr/local/apache2/conf/ssl/ssl.key"

    ProxyPassMatch "^/(.*\.php)$" "fcgi://phpfpm:9000/var/www/html/public_html/$1"

    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>
```

{{< alert type="info" >}}
ProxyPassMatch 設定 `fcgi://php:9000 ...`，這裡設定 fcgi:// 的主機為 php:9000，對應到即將設定的 docker-compose.yml 中的 php-fpm 的 service 名稱。docker compose 中會將每個 service 作為 docker 虛擬網路中的 DNS 主機名稱，讓 service 彼此之間可以互相通訊。
{{< /alert >}}

### 建立 php/Dockerfile

```Dockerfile{linenos=true}
FROM php:7.2.34-fpm

# 可傳入參數 USER_ID 和 GROUP_ID
# 預設使用 1000
ARG USER_ID=1000
ARG GROUP_ID=1000

# 建立對應 Host UID/GID 的使用者
RUN groupadd -g ${GROUP_ID} hostuser \
    && useradd -u ${USER_ID} -g hostuser -m hostuser

RUN docker-php-ext-install pdo_mysql

# 變更 PHP-FPM 執行身份
RUN sed -i 's/^user = www-data/user = hostuser/' /usr/local/etc/php-fpm.d/www.conf \
    && sed -i 's/^group = www-data/group = hostuser/' /usr/local/etc/php-fpm.d/www.conf \
    && sed -i 's/^listen.owner = www-data/listen.owner = hostuser/' /usr/local/etc/php-fpm.d/www.conf \
    && sed -i 's/^listen.group = www-data/listen.group = hostuser/' /usr/local/etc/php-fpm.d/www.conf

USER hostuser

WORKDIR /var/www/html
```

### 建立 docker-compose.yml

```yml{linenos=true}
services:
  # PHP-FPM 服務 (處理 PHP 邏輯和寫入權限，服務名稱: phpfpm)
  phpfpm:
    build:
      context: ./php
      # 可傳入 USER_ID 和 GROUP_ID
      args:
        USER_ID: 1000
        GROUP_ID: 1000
    container_name: perfumer-php
    restart: unless-stopped
    volumes:
      # 掛載程式碼，必須與 Apache 服務掛載到相同位置
      - ./:/var/www/html/ 
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - custom-net

  # Apache Web Server 服務 (處理 HTTP/HTTPS 請求，服務名稱: web)
  web:
    build: 
      context: ./apache
      # 可傳入 USER_ID 和 GROUP_ID
      args:
        USER_ID: 1000
        GROUP_ID: 1000
    container_name: perfumer-httpd
    restart: unless-stopped
    # 埠號映射
    ports:
      - "4080:80"
      - "4443:443"
    volumes:
      # 程式碼掛載 (與 php 服務一致)
      - ./:/var/www/html/
      # Apache 配置和憑證掛載
      - ./apache/httpd.conf:/usr/local/apache2/conf/httpd.conf
      - ./apache/vhost.conf:/usr/local/apache2/conf/extra/httpd-vhosts.conf
      - ./apache/ssl:/usr/local/apache2/conf/ssl
    depends_on:
      - phpfpm # 確保 PHP 服務先啟動
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - custom-net

networks:
  custom-net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.10.20.0/24
          gateway: 10.10.20.1
```

### 啟動 docker compose

以上設定完成後，切換工作目錄到專案目錄 mysite

```bash
# docker compose up 啟動容器
# --build 建置
# -d 背景執行
docker compose up --build -d
```

若成功，應可用 `https://www.mysite.localhost:4443` 存取網站。

## 設定防火牆

在 docker compose 中自訂了子網路 `custom-net`，網段為`10.10.20.0/24`，主要用來透過該 bridge 來連線到 host 的資料庫或其他服務。故需要在 host 開放防火牆以及相關設定。

### 允許 container 存取 host 的 mariadb

首先開放防火牆(ufw)

```bash
sudo ufw allow from 10.10.20.0/24 to any port 3306 proto tcp

# 檢查是否新增成功
sudo ufw status verbose
```

- sudo ufw allow: 允許通過防火牆。

- from 10.10.20.0/24: 指定允許的來源 IP 範圍。這就是您的 Docker 網路子網段。

- to any: 允許發送到 Host 上的任何目標位址（即 Host 本機）。

- port 3306: 指定允許的目標埠號（MariaDB/MySQL 埠）。

- proto tcp: 指定使用 TCP 協定（MariaDB/MySQL 使用 TCP）。

### 修改 mariadb 設定檔

要讓外部 ip 連線到 mariadb，還需要在 mariadb 的設定檔設定 bind-address。

```conf
# 編輯設定檔(每個版本的 mariadb 設定檔路徑可能不同)
# /etc/mysql/mariadb.conf.d/50-server.cnf

# 註解原本的 bind-address
# bind-address = 127.0.0.1

# 允許外部登入的 ip address
# 允許所有外部 ip 連線
bind-address = 0.0.0.0

```

設定完後請**重新啟動 mariadb**。

{{< alert type="warning" >}}
因為是 development 環境，所以 bind-address 設定為 0.0.0.0 較方便。若是 production 環境，請僅開放允許的 ip。
{{< /alert >}}

### 建立 mariadb 帳號

使用 root 登入 mariadb，建立允許來自子網路 `custom-net` 的 user。

```sql
/* 建立使用者 */
CREATE USER 'myuser'@'10.10.20.%' IDENTIFIED BY 'CustomPassword';

/* 分配權限給使用者 */
GRANT ALL PRIVILEGES ON `dbname`.* TO 'myuser'@'10.10.20.%';

/* 刷新權限 */
FLUSH PRIVILEGES;
```

### mariadb 連線字串

開啟專案目錄將資料庫連線的 DSN 的 host 設定為 `host.docker.internal`。

## 補充

### container 連線到 host 其他服務

若 container 需要連線到 host 的其他服務，注意以下設定

- 開放 host 防火牆，允許 container 子網路 ip 存取。
- 將 container 連線到 host 主機位置設定為 `host.docker.internal`。

### install php extensions

若要安裝 php extensions，可能會需要自行安裝相關依賴套件或設定。  
docker hub 的 php 官方分享一個開源項目，提供便利的安裝 php extensions 方式。

[Easy installation of PHP extensions in official PHP Docker image](https://github.com/mlocati/docker-php-extension-installer)

編輯 php/Dockerfile 加入以下內容

```Dockerfile{linenos=true}
# 安裝 PLUGIN install-php-extensions
ADD --chmod=0755 https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/

# 安裝需要的 php extensions(例如 gd, xdebug)
RUN install-php-extensions gd xdebug
```

{{< alert type="notice" >}}
若 Dockerfile 在 build 過程中出現無法成功安裝所需的套件而退出，可以檢查是否 DNS 將套件來源網址的 DNS 解析為 ip V6。

```bash
ping deb.debian.org
# 若回應為 ip V6 可能會造成建置失敗
```

由於 docker 與 host 之間使用 ip V6 可能會發生無法正確解析問題，
此時可以到網路設定將 DNS 加入 8.8.8.8 和 1.1.1.1。
{{< /alert >}}

### 設定 php.ini 內容

若要自訂 php-fpm 的 php.ini 內容，可用掛載 volumes 的方式。步驟如下

新增 php/php.ini

```ini
# 此檔案用來 override 設定，因此僅需設定需要變更的項目。例如以下設定
memory_limit = 512M
upload_max_filesize = 50M
post_max_size = 50M
max_execution_time = 300
date.timezone = Asia/Taipei
```

編輯 docker-compose.yml，將檔案掛載到 php-fpm service 區塊的 volumes。

```yml
volumes:
  #...
  - ./php/php.ini:/usr/local/etc/php/conf.d/custom.ini
```

將 host 的 `./php/php.ini` 掛載到 container 的 `/usr/local/etc/php/conf.d/` 目錄下。  
檔名可自取，例如 custom.ini 或 99-override-php.ini。container 會自動依檔名順序載入 conf.d 目錄下的設定，後載入項目的會覆蓋前面載入的項目。

設定完成後重新啟動 `docker compose`。可呼叫 `phpinfo()` 檢視設定是否成功。

### 使用 php cli 運行 php 腳本

若需要使用 php cli 的方式來運行 php 腳本，則可以使用 docker 來處理

例如

1. php-fpm 在 docker-compose 的 container_name 為 perfumer-php。
2. 要運行的腳本若位於 `console/my_php_script.php`。

則在 bash 下輸入

```bash
docker exec -it perfumer-php php /var/www/html/console/my_php_script.php
```

即可用 php-fpm container 去運行 php 腳本。
