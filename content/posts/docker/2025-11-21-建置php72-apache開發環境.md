---
title: "建置 php:7.2.34-apache 網站開發環境"
date: 2025-11-22 10:30:00 +0800
categories: 
  - docker
tags:
  - docker
  - php
---

{{< alert type="warning" >}}
建議參考 [建置php72-fpm開發環境]({{< ref "./2025-11-22-建置php72-fpm開發環境.md" >}})可解決檔案目錄寫入權限問題。
{{< /alert >}}

舊專案使用 php 7.2 環境開發，故使用 Docker 作為開發環境的 container。

主要達成以下目的

- 專案目錄為 `mysite`
- 使用 php 7.2 運行網站
- 加上測試用自簽憑證
- 使用 `www.mysite.localhost` 作為主機名稱
  - `http://www.mysite.localhost:4080`
  - `https://www.mysite.localhost:4443`
- 資料庫為 host 所安裝的 mariadb 11。

## 專案目錄結構配置

在專案目錄 mysite 下加入以下檔案與目錄結構

```conf
mysite/
  Dockerfile # 自訂 docker image
  docker-compose.yml # docker compose 設定檔
  config/
    vhost.cnf # apache 的 virtual host 設定檔
    ssl.crt # 自訂憑證
    ssl.key # 自訂憑證私鑰
```

### 建立測試憑證

切換工作目錄至 mysite/config

```bash
# 工作目錄: mysite/config

# 使用 openssl 生成私鑰 (ssl.key) 和憑證 (ssl.crt)
# 建立有效 10 年憑證
# CN=www.mysite.localhost 是重點，必須與您設定的網址一致
openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
    -keyout ssl.key \
    -out ssl.crt \
    -subj "/C=TW/ST=Taipei/L=Sanchong/O=MySite Dev/CN=www.mysite.localhost"

# 執行後產生 ssl.crt 與 ssl.key
```

### 建立 Dockerfile

```Dockerfile{linenos=true}
FROM php:7.2.34-apache

RUN docker-php-ext-install pdo_mysql

RUN a2enmod ssl rewrite
```

### 建立 vhost.conf

建立檔案 mysite/config/vhost.conf

```conf
# 啟用對上層目錄的存取
# 這是為了讓 public_html/index.php 可以存取到 /var/www/html/ 根目錄下的其他檔案
<Directory /var/www/html>
    Require all granted
</Directory>

# 允許用 .htaccess 覆蓋設定
# 允許檔案存取
<Directory /var/www/html/public_html>
    AllowOverride All
    Require all granted
</Directory>

<VirtualHost *:80>
    ServerName www.mysite.localhost:4080

    # 設置 DocumentRoot (容器內部路徑)
    DocumentRoot /var/www/html/public_html
    
    # 可選：將 HTTP 請求重定向到 HTTPS (如果您希望強制加密)
    # RewriteEngine On
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}:4443$1 [R=301,L]
    
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>

<VirtualHost *:443>
    ServerName www.mysite.localhost:4443
    DocumentRoot /var/www/html/public_html
    DirectoryIndex index.php index.html

    # SSL/TLS 設定
    SSLEngine on
    # 指向容器內，我們將要掛載的憑證路徑
    SSLCertificateFile    /etc/ssl/certs/mysite.crt
    SSLCertificateKeyFile /etc/ssl/private/mysite.key

    # 錯誤與日誌
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>
```

### 建立 docker-compose 設定檔

建立 mysite/docker-compose.yml

```yml{linenos=true}
services:
  web:
    # 告訴 Docker Compose 使用當前目錄的 Dockerfile 進行建構
    build:
      context: . 

    container_name: www-mysite-localhost

    # 自動啟動
    restart: always

    # 使用自訂的網路設定
    networks:
      - custom-net
    
    ports:
      # host port 4080 指向 container port 80
      - "4080:80"
      # host port 4443 指向 container port 443
      - "4443:443"

    volumes:
      # 1. 掛載整個專案目錄 ( Host: mysite/ -> Container: /var/www/html )
      # 這樣 public_html, index.php, config 等都在容器內 /var/www/html 下
      - ./:/var/www/html/ 

      # 2. 掛載 VirtualHost 設定檔
      - ./config/vhost.conf:/etc/apache2/sites-enabled/000-default.conf

      # 3. 掛載 SSL 憑證到容器內安全的路徑 (必須與 default.conf 內的 SSLCertificateFile 路徑一致)
      - ./config/ssl.crt:/etc/ssl/certs/mysite.crt
      - ./config/ssl.key:/etc/ssl/private/mysite.key
    
    # 為了讓 container 可以連線到 host 的服務，須設定 host.docker.internal:host-gateway
    extra_hosts:
      - "host.docker.internal:host-gateway"

# 自訂 docker compose 使用的子網路
# 將透過此子網路連線到 host
# 例如 container 要連到 host mysql，必須開放防火牆允許此子網路存取
networks:
  custom-net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.10.20.0/24
          gateway: 10.10.20.1
```

### 啟動 docker compose

以上設定完成後，切換工作目錄到專案目錄 mysite

```bash
# docker compose up 啟動容器
# --build 建置
# -d 背景執行
docker compose up --build -d
```

若成功，應可用 `https://www.mysite.localhost:4443` 存取網站。

## 設定防火牆

在 docker compose 中自訂了子網路 `custom-net`，網段為`10.10.20.0/24`，主要用來透過該 bridge 來連線到 host 的資料庫或其他服務。故需要在 host 開放防火牆以及相關設定。

### 允許 container 存取 host 的 mariadb

首先開放防火牆(ufw)

```bash
sudo ufw allow from 10.10.20.0/24 to any port 3306 proto tcp

# 檢查是否新增成功
sudo ufw status verbose
```

- sudo ufw allow: 允許通過防火牆。

- from 10.10.20.0/24: 指定允許的來源 IP 範圍。這就是您的 Docker 網路子網段。

- to any: 允許發送到 Host 上的任何目標位址（即 Host 本機）。

- port 3306: 指定允許的目標埠號（MariaDB/MySQL 埠）。

- proto tcp: 指定使用 TCP 協定（MariaDB/MySQL 使用 TCP）。

### 修改 mariadb 設定檔

要讓外部 ip 連線到 mariadb，還需要在 mariadb 的設定檔設定 bind-address。

```conf
# 編輯設定檔(每個版本的 mariadb 設定檔路徑可能不同)
# /etc/mysql/mariadb.conf.d/50-server.cnf

# 註解原本的 bind-address
# bind-address = 127.0.0.1

# 允許外部登入的 ip address
# 允許所有外部 ip 連線
bind-address = 0.0.0.0

```

設定完後請**重新啟動 mariadb**。

{{< alert type="warning" >}}
因為是 development 環境，所以 bind-address 設定為 0.0.0.0 較方便。若是 production 環境，請僅開放允許的 ip。
{{< /alert >}}

### 建立 mariadb 帳號

使用 root 登入 mariadb，建立允許來自子網路 `custom-net` 的 user。

```sql
/* 建立使用者 */
CREATE USER 'myuser'@'10.10.20.%' IDENTIFIED BY 'CustomPassword';

/* 分配權限給使用者 */
GRANT ALL PRIVILEGES ON `dbname`.* TO 'myuser'@'10.10.20.%';

/* 刷新權限 */
FLUSH PRIVILEGES;
```

### mariadb 連線字串

開啟專案目錄將資料庫連線的 DSN 的 host 設定為 `host.docker.internal`。

### 補充：其他服務設定

若 container 需要連線到 host 的其他服務，注意以下設定

- 開放 host 防火牆，允許 container 子網路 ip 存取。
- 將 container 連線到 host 主機位置設定為 `host.docker.internal`。
