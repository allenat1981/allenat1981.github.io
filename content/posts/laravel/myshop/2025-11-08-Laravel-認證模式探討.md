---
title: "Laravel 認證模式(authentication flow)探討"
date: 2025-11-08 13:40:00 +0800
categories: 
  - laravel
tags:
  - laravel
  - myshop
---

Laravel 內建 authentication 機制，以 session cookie 作為基本的驗證方式。另外提供 sanctum 和 passport 套件，提供進一步的驗證功能。

- authentication 適用於傳統的 session cookie 認證。
- sanctum 可同時處理 session cookie 與 API Token。
- passport 則可用在更進階的 OAuth2 驗證。

在一般專案中，若是 MPA(Multi-Page Application) 模式，通常使用 authentication 即可。若是 SPA ，則可使用 sanctum 或更進階的 passport。

以簡單的前後台網站為例，有以下三種身分的使用者

- Guest 尚未登入的前台使用者
- User 已登入的前台使用者(會員)
- Admin 網站後台管理者

若不考慮 App 、不同子網域、跨域存取，則用 authentication 即可。主要處理的部分包括：

- 身分認證
- CSRF Protection

## 身分認證

身分認證主要以 session cookie 作為認證模式。故只要在 route 加上 middleware: auth ，並設定對應的 guard 即可。可參考 [Authentication-自訂認證]({{< ref "./2025-04-15-Authentication-自訂認證.md" >}})

## CSRF Protection

CSRF Protection 主要有以下方式

### MPA 模式

若網站是 MPA 模式，則表單通常是在 blade 樣板內透過 `<form>` 送出，這種情況下可在表單內加上 `@csrf` 即可。

### SPA 模式

若網站是 SPA 模式，且 entry 非透過 middleware group: web 渲染的頁面，則建議透過 sanctum 所提供的 API `/sanctum/csrf-cookie` 產生 XSRF-TOKEN。

主要的步驟如下

1. 編輯 `config/sanctum.php`，設定好 SPA domain。
2. 編輯 `bootstrap/app.php`，在 `withMiddleware` 加入 `$middleware->statefulApi();`。
3. 替 axios 加入 `axios.defaults.withCredentials = true` 與 `axios.defaults.withXSRFToken = true;`
4. 在首次進入 SPA 時，調用 API，例如 `axios.get('/sanctum/csrf-cookie')`。

透過以上 Laravel 即會產生 XSRF-TOKEN 並回傳儲存在 client 端的 cookie，後續的 request 將會透過 header 夾帶 XSRF-TOKEN 進行 CSRF 驗證。

### MPA 合併 SPA 模式

此模式通常是 SPA 的 entry 頁面會透過 middleware group: web 渲染，因為 web 包含 middleware: VerificyCsrfToken，VerifyCsrfToken 會產生 CSRF Token，並 response 到 client 並存在 cookie，所以不需要另外呼叫 `/sanctum/csrf-cookie`。

此情況下使需要替 axios 加入 `axios.defaults.withCredentials = true` 與 `axios.defaults.withXSRFToken = true;` 即可。

### 小結

1. 在 `MPA` 或 `MAP 混搭 SPA` 模式下，若僅使用 session cookie 作為認證方式，可以不需要特地安裝和使用 sanctum 套件。
2. 若在純 `SPA` 模式下，建議使用 sanctum 進行身分認證和 CSRF Protection。

## 補充-Laravel CSRF 機制探討

以下來源是 ChatGPT 回應，僅供參考。

Laravel 其實有兩套 CSRF token 機制

|類型|使用情境|來源|
|----|--------|----|
|Laravel 核心的 CSRF 保護|Blade / session 型網站（web middleware group）|middleware:VerifyCsrfToken|
|Sanctum 的 CSRF 保護|SPA / API 模式（sanctum/csrf-cookie）|middleware:EnsureFrontendRequestsAreStateful|

兩者都會產生一個名為 XSRF-TOKEN 的 cookie。
但「什麼時候產生」與「怎麼產生」不一樣。

### middleware:VerificyCsrfToken

若頁面是透過 Laravel 的 middleware group: `web` 生成，則此 middleware 會包含

```php
\Illuminate\Foundation\Http\Middleware\VerifyCsrfToken::class
```

而這個 middleware 會在每次回傳視圖 (Blade 或 HTML) 時自動呼叫：

```php
$request->session()->token()
```

Laravel 在這一步會自動：

- 產生一個新的 CSRF token；

- 存到 session；

- 並且發一個名為 XSRF-TOKEN 的 cookie。

因此就算沒呼叫 /sanctum/csrf-cookie，只要你有載入過任何「包含 CSRF middleware 的頁面」，瀏覽器仍然會收到 XSRF-TOKEN cookie。

這是 Laravel 核心 CSRF 機制自動產生的，不是 Sanctum 專屬。

### sanctum:csrf-cookie

那 /sanctum/csrf-cookie 的用途是什麼？

這個 endpoint 是為了 純 SPA（例如 Vue / React 前端） 使用：

- 當前端第一次載入頁面（不透過 Laravel Blade），
- 也沒有跑過 web middleware，
- 也就不會有 session 與 CSRF token，

那就需要手動呼叫：

```js
axios.get('/sanctum/csrf-cookie');
```

Laravel 會在這個 API 回傳時：

建立 session，

產生 XSRF-TOKEN，

回傳 cookie 給瀏覽器。

如此之後，SPA 的 API 請求才會有 CSRF 保護可用。

### 比喻理解

|狀況|誰產生 XSRF-TOKEN|
|----|-----------------|
|傳統 Laravel Blade 頁面|VerifyCsrfToken middleware 自動產生|
|SPA (前端獨立)|/sanctum/csrf-cookie 產生|
|兩者混合 (MPA + SPA 混用)|兩邊都可能產生，但值會一致（因為同 session）|

- 你的首頁是 Blade 頁面（有跑過 web middleware）；
- Laravel 自動幫你設了 XSRF-TOKEN；
- 所以即使沒打 /sanctum/csrf-cookie，你仍會在 cookie 看到它。

這完全正常，不會有衝突或安全問題。
Sanctum 只是沿用 Laravel 原本的 CSRF token 機制而已。
