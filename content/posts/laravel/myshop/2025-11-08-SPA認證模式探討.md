---
title: "SPA 認證模式(authentication flow)探討"
date: 2025-11-08 13:40:00 +0800
categories: 
  - laravel
tags:
  - laravel
  - myshop
---

若網站的部份功能採取 SPA 模式，Laravel 提供 sanctum 或 passport 機制進行 user 認證。

但若是只考慮 session cookie 的機制進行認證，可以不需要用到 sanctum 和 passport，直接使用內建的的 authentication 來進行認證。

## auth, sanctum, passport

authentication 適用於傳統的 session cookie 認證。

sanctum 可同時處理 session cookie 與 API Token。

passport 則可用在更進階的 OAuth2 驗證。

### 使用 auth 認證 SPA 的條件

因為 session cookie 預設必須在同一個域名底下，所以 SPA 前端與 laravel 後端必須在同一域名底下。

### 關於 CSRF 的問題

SPA 若使用 axios 進行後端資料的存取，無法直接在表單內直接加上 `@csrf`，官網提到可以在 request header 加上 `X-CSRF-TOKEN`。如範例：

```html{linenos=true}
<meta name="csrf-token" content="{{ csrf_token() }}">
```

並在送出 request 時加入 header `X-CSRF-TOKEN`。以 axios 為例，可設定

```typescript{linenos=true}
const axiosInstance = axios.create({
    headers: {
        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
    },
    withCredentials: true,
    ...
});
```

但是遇到的問題是一但 user 登入後，即使沒有 `session()->regenerate()`，csrf token 仍然會更新，並且因為 SPA 的關係，更新後的 csrf token 無法立即回饋到 client。

嘗試透過 `csrf_token()`　將更新的 csrf_token 回應給 client，但並沒辦法順利改變已設定的 axios header `X-CSRF-TOKEN`。

目前發現使用 `sanctum` 提供的 GET `/sanctum/csrf-cookie` 可以暫時解決此問題。ChatGPT 建議在初次進入 SPA 或登入前須先請求，故先以此方式實作。
