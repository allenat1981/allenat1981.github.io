---
title: "加解密與數位簽章與網站憑證"
date: 2025-02-04 16:15:00 +0800
categories: 
  - Other
tags:
  - TLS
---

用來釐清加解密與數位簽章與網站主機憑證的基本概念。

## 參考資料

- [應用密碼學](https://hitcon.org/2018/CMT/slide-files/d1_s2_r4.pdf)
- [公開金鑰加密](https://zh.wikipedia.org/zh-tw/%E5%85%AC%E5%BC%80%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86)
- [數位簽章](https://zh.wikipedia.org/zh-tw/%E6%95%B8%E4%BD%8D%E7%B0%BD%E7%AB%A0)
- [How Does HTTPS Work? RSA Encryption Explained](https://tiptopsecurity.com/how-does-https-work-rsa-encryption-explained/)

## 加解密與雜湊

名詞解釋：

- 加解密是雙向的，意指加解密的運算可以將明文加密為密文，也可以將密文解密為明文。
  - 加密 Encrypt：指將明文經過某種程序轉換成密文，該程序稱為加密
  - 解密 Decrypt：指將密文經過某種程序轉換成明文，該程序稱為解密
  - 明文 Plaintext：加密前的訊息
  - 密文 Cipertext：加密後的訊息
  - 金鑰 / 密鑰 Key：加解密時所使用的「鑰匙」
  - 以上節錄自應用密碼學.pdf。
- 雜湊(hash)則是單向的，意旨雜湊運算只能將資料計算成一組原則上無法復原的資料，根據不同的演算法將產生不同長度的雜湊資料。
  - 因為雜湊資料的長度可能是固定的，因此雜湊是有極小的機率產生碰撞的風險。

### 對稱式加密

一般來說加密是將明文與金鑰丟進演算法進行運算後產生密文，因此金鑰必須被妥善保存避免外流，一旦金鑰外流也就代表資料已經不安全，並有洩密之風險。

加密的方式又分為對稱式和非對稱式二種。對稱式加密代表加解密的過程所用的金鑰式是同一支。常見的對稱式加密演算法為：

- DES
- AES

### 非對稱式加密

非對稱式加密則是透過金鑰演算法計算出一組(pair)私鑰(private key)/公鑰(public key)，明文需透過公鑰加密為密文；密文需透過私鑰解密為明文。另外在數位簽章時，則通常會反過來，傳送端用私鑰加密，接收端用公鑰解密。非對稱式加密的金鑰一定是一組，公鑰加密必定是利用私鑰解密，私鑰加密則是利用公鑰解密，不會發生公鑰加密後可用公鑰解密，或私鑰加密後可用私鑰解密的情況。

在 2 個或 2 個以上使用者互相傳輸資料的過程，則雙方都必須產生一組私鑰/公鑰，接著將彼此的公鑰進行交換，傳輸資料則透過對方給予的公鑰進行加密，接收資料後則透過己方保留的私鑰進行解密，簡述如下：

假設 A 與 B 二個使用者要進行非對稱加密的資料傳輸

1. A 在自己的主機產生一組金鑰，分別為 pub-A (公鑰)與 pri-A (私鑰)。
2. B 在自己的主機產生一組金鑰，分別為 pub-B (公鑰)與 pri-B (私鑰)。
3. A 將自己的 pub-A 傳送給 B 保存；B 將自己的 pub-B 傳送給 A 保存。
4. A 傳送資料給 B 時，將明文與 pub-B 透過加密公式演算成密文，再將密文傳送給 B。
5. B 收到 A 傳來的密文，透過 pri-B 解密為明文。
6. 同樣，當 B 要傳送資料給 A ，則透過 pub-A 將明文加密為密文；A 收到密文後，透過 pri-A 解密為明文。

常見的非對稱式加密演算法為：

- RSA

### 混合對稱加密 Hybrid cryptosystem

非對稱式加解密的運算較慢，另外有一種結合對稱式加密與非對稱式加密的混合對稱加密方法。其原理是產生一支對稱式加密的金鑰(又稱會議金鑰 Session Key)用來加解密明文內容，接著再產生一組非對稱式的金鑰用來加解密 Session Key，接著將加密後的密文與 Session Key 一起傳送。接收端收到資料後，使用私鑰將 Session Key 解開後，再用 Session Key 來將密文解密為明文。

簡單來說，混合式的作法就是將加解密明文的金鑰(Session Key)當成傳輸資料的一部分。在這個過程中，運算較快的對稱式加密用來處理資料量較大的明文，運算較慢的非對稱式加密只用在對 Session Key 進行處理，藉此減少對整個明文進行非對稱式加解密的運算成本。目前的 https 機機制大概都採用此加密方式。

### 雜湊 hash

以下節錄自應用密碼學.pdf

常見的雜湊運用：

1. 驗證資料完整性（Data integrity）
   1. 用不安全通道傳很大的檔案
   2. 用安全通道傳該檔案的 Hash，以節省加密解密所需的資源
2. 在不取得明文的情況下驗證資料正確性
   1. 儲存使用者密碼的 Hash 在資料庫，確保管理員看不到使用者密碼的明文

上述雜湊的運用即接近數位簽章的概念。常見的雜湊演算法有

- md5
- sha1

#### 數位簽章的概念

在資料傳輸的過程加上數位簽章，可以讓接收端透過驗證數位簽章來確認資料內容在傳輸過程是否有被異動。

數位簽章的概念主要是透過資料提供端將原始資料進行簽章的雜湊演算法產生一組不容易產生碰撞的位元組合，此位元組合即為該傳輸資料的數位簽章，並將該簽章另外提供給接收端。接收端在收到資料後，透過相同的演算法計算出簽章的雜湊值，若與提供端所提供的簽章一致就代表通過驗證，此時可以確認接收到的資料與提供者所提供的一致，並沒有被竄改。反之，若接收端計算出來的雜湊與提供者的簽章不一致，則代表接收到的資料與提供者所提供的原始資料不一致，就必須提防資料是否在傳輸過程中受到竄改。

以下簡述基本的概念：

假設 A 從 B 的網站下載某套件或資料，B 除了提供該套件的原始資料外，還提供了透過 md5 或 sha1 運算出來的數位簽章。

1. A 從 B 網站下載了 share-project 以及 md5 的數位簽章。
2. 下載完畢後，A 將 share-B 的套件透過 md5 進行雜湊，並與 B 提供的數位簽章進行比對。若比對一致則代表 share-project 在傳輸過程中並沒有被竄改；若比對失敗則代表 A 所下載的 share-project 內容有問題，此時應該避免使用 share-project。

注意事項：

1. 每份原始資料透過雜湊後產生相對應的數位簽章，二者是一組(pair)的搭配。
2. 數位簽章只用來驗證接收端所接收到的資料是否與提供端的原始資料一致。
3. 原始資料可以是明文，也可以是密文。傳輸資料是否加密是由提供者決定。
   1. 數位簽章可以搭配對稱式加密和非對稱式加密。
   2. 例如 TLS 就是非對稱加密並且加上數位簽章進行傳輸。
4. 若傳輸資料是以明文傳送，則在資料當中不應該包含使用者密碼或敏感資料。
5. 數位簽章不一定會使用完整的明文資料，有可能僅使用部分的資料內容，並且使用自訂的雜湊步驟
   1. 例如 JWT 會將 header 和 payload 進行 base64 編碼，接著再透過選定的雜湊產生簽章(signature)

常見數位簽章的應用，例如 JWT 或者是與 API 協力廠商約定好簽章的演算與驗證方式。

### 小結

1. 加解密主要是用來保護資料內容，避免資料明文被不該看到的人看到。主要使用對稱式加密和非對稱式加密的運算。
2. 數位簽章是要確保資料內容的一致性，避免資料在傳輸過程中被竄改。主要使用雜湊運算。
3. 資料傳輸時的加解密與數位簽章基本上可以自行搭配使用，若要越高的安全性則可以運用更多層的加解密與簽章，但是相對的就要付出更高的運算成本。
4. [憑證參考資料請看此文章](https://ithelp.ithome.com.tw/articles/10230996)

## 網站主機憑證概念

僅說明 WebServer 申請與驗證憑證的基本概念。

### TLS 網站主機憑證申請流程

僅記錄簡單的網站 TLS 憑證概念

參考資料：[如何使用 OpenSSL 工具產製 CSR 憑證要求檔並成功申請正式 TLS 憑證](https://blog.miniasp.com/post/2022/06/14/How-to-request-new-tls-certificate-using-OpenSSL)

申請與安裝 TLS 流程簡述

1. 網站主機(Server) 產生私鑰與憑證要求檔(CSR)，參考保哥的教學操作，會產生一個私鑰檔(private key)和一個 .csr 檔。
   1. 保哥的參考資料這裡沒有提到公鑰，因此猜測公鑰資料應該已經被包含在憑證要求檔 CSR
2. 將 CSR 送到憑證申請單位
3. 申請成功將會從憑證申請單位拿到以下三個檔
   1. 根憑證 Root Certificate (root.cer)
   2. 中繼憑證 Intermediate Certificate (uca.cer)
   3. 伺服器憑證 Server Certificate (server.cer)
4. 在主機的網站伺服器設定憑證與私鑰檔
   1. 可參考[Apache設定 TLS](../Apache/Apache設定TLS.md)

#### 憑證驗證

請參考：[Week10 - HTTPS的S到底怎麼運作的，為什麼非對稱金鑰需要數位簽章來組成憑證呢 - 資安介紹篇](https://ithelp.ithome.com.tw/articles/10230996)

請注意！此教學文章不一定正確，僅作概念上的說明

Client 端的主機會有一個受信任的憑證庫，包含受到信任的第三方憑證。Client 透過瀏覽器瀏覽主機時會有以下驗證流程：

1. Client 從 Web Server 取得憑證資料
   1. 從憑證取得 Web Server 提供的 public key(Server-pub-key) 和 Web Server 的資訊(Server-info)
   2. Client 將取得 Server-pub-key 和 Server-info 進行 Hash 取得 HashCode-A
2. Client 從憑證資料中取得簽章以及憑證的簽發單位(第三方信任憑證單位 3rd-party)
3. Client 檢查憑證的簽發單位是否在本機端的受信任的憑證庫，若為受信任憑證則取得簽發單位的公鑰(3rd-pub-key)
4. 利用 3rd-pub-key 解密簽章獲得 HashCode-B
5. 驗證 HashCode-A 與 HashCode-B 是否相符，若相符則代表此憑證有效。Client 可以確認 Server 的憑證與公開金鑰沒有問題。

請注意！以上僅是簡述的文字說明，憑證簽章的加解密與驗證可能與事實有出入，之後有找到更好的說明請更新。
